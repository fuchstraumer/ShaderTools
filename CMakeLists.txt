INCLUDE(ExternalProject)
CMAKE_MINIMUM_REQUIRED(VERSION 3.3)
PROJECT(ShaderTools)

SET(SHADERC_SKIP_TESTS ON)
SET(SHADERC_THIRD_PARTY_ROOT_DIR "${CMAKE_CURRENT_SOURCE_DIR}/third_party")
SET(SHADERC_SPIRV_HEADERS_DIR "${CMAKE_CURRENT_SOURCE_DIR}/third_party/spirv-headers")
SET(SHADERC_GLSLANG_DIR "${CMAKE_CURRENT_SOURCE_DIR}/third_party/glslang")
SET(SHADERC_SPIRV_TOOLS_DIR "${CMAKE_CURRENT_SOURCE_DIR}/third_party/spirv-tools")
ADD_SUBDIRECTORY("${CMAKE_CURRENT_SOURCE_DIR}/third_party/shaderc" EXCLUDE_FROM_ALL)
ADD_SUBDIRECTORY("${CMAKE_CURRENT_SOURCE_DIR}/third_party/spirv-cross" EXCLUDE_FROM_ALL)
ADD_SUBDIRECTORY("${CMAKE_CURRENT_SOURCE_DIR}/third_party/luajit" EXCLUDE_FROM_ALL)
ADD_SUBDIRECTORY("${CMAKE_CURRENT_SOURCE_DIR}/third_party/sol2" EXCLUDE_FROM_ALL)
ADD_SUBDIRECTORY("${CMAKE_CURRENT_SOURCE_DIR}/third_party/mango" EXCLUDE_FROM_ALL)


FILE(GLOB COMMON "${CMAKE_CURRENT_SOURCE_DIR}/src/common/*.cpp" "${CMAKE_CURRENT_SOURCE_DIR}/include/common/*.hpp")
FILE(GLOB UTIL "${CMAKE_CURRENT_SOURCE_DIR}/src/util/*.cpp" "${CMAKE_CURRENT_SOURCE_DIR}/src/util/*.hpp")
FILE(GLOB GENERATION "${CMAKE_CURRENT_SOURCE_DIR}/src/generation/*.cpp" "${CMAKE_CURRENT_SOURCE_DIR}/include/generation/*.hpp")
FILE(GLOB PARSER "${CMAKE_CURRENT_SOURCE_DIR}/src/parser/*.cpp" "${CMAKE_CURRENT_SOURCE_DIR}/include/parser/*.hpp")
FILE(GLOB LUA "${CMAKE_CURRENT_SOURCE_DIR}/src/lua/*.cpp" "${CMAKE_CURRENT_SOURCE_DIR}/include/lua/*.hpp")
FILE(GLOB HEADERS "${CMAKE_CURRENT_SOURCE_DIR}/include/*.hpp")

FIND_PACKAGE(Vulkan REQUIRED)

ADD_LIBRARY(ShaderTools STATIC ${SOURCES} ${HEADERS})
SET_PROPERTY(TARGET ShaderTools PROPERTY CXX_STANDARD 17)
TARGET_COMPILE_DEFINITIONS(ShaderTools PRIVATE -DSHADERTOOLS_BUILD_DLL)
TARGET_LINK_LIBRARIES(ShaderTools shaderc spirv-cross-core spirv-cross-glsl spirv-cross-cpp)
TARGET_INCLUDE_DIRECTORIES(ShaderTools PUBLIC "${CMAKE_CURRENT_SOURCE_DIR}/third_party/" "${CMAKE_CURRENT_SOURCE_DIR}/include" "${Vulkan_INCLUDE_DIRS}")
TARGET_INCLUDE_DIRECTORIES(ShaderTools PRIVATE "${CMAKE_CURRENT_SOURCE_DIR}/ext/include")

TARGET_COMPILE_DEFINITIONS(ShaderTools PRIVATE "-D_SILENCE_ALL_CXX17_DEPRECATION_WARNINGS")

INSTALL(DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/include/" DESTINATION "${CMAKE_INSTALL_INCLUDEDIR}/ShaderTools/")
INSTALL(TARGETS ShaderTools RUNTIME DESTINATION "bin" LIBRARY DESTINATION "lib" ARCHIVE DESTINATION "lib")

OPTION(BUILD_TESTS "Build some test executables for shader parsing and compiliation." OFF)
IF(BUILD_TESTS)
    ADD_EXECUTABLE(ParseTest0 "${CMAKE_CURRENT_SOURCE_DIR}/tests/test.cpp")
    ADD_DEPENDENCIES(ParseTest0 ShaderTools)
    TARGET_LINK_LIBRARIES(ParseTest0 ShaderTools)
    TARGET_INCLUDE_DIRECTORIES(ParseTest0 PRIVATE "${CMAKE_CURRENT_SOURCE_DIR}/include")
ENDIF()